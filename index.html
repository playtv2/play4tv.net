package com.example.hotplaytv

import android.content.Context
import android.graphics.Bitmap
import android.graphics.Color
import android.net.Uri
import android.os.Bundle
import android.os.CountDownTimer
import android.os.Handler
import android.os.Looper
import android.os.SystemClock
import android.view.KeyEvent
import android.view.MotionEvent
import android.view.View
import android.view.ViewGroup
import android.view.inputmethod.InputMethodManager
import android.webkit.*
import android.widget.Button
import android.widget.FrameLayout
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.VideoView
import androidx.appcompat.app.AppCompatActivity
import com.example.hotplaytv.R

class MainActivity : AppCompatActivity() {

    private lateinit var videoView: VideoView
    private lateinit var webView: WebView
    private lateinit var btnSearch: Button
    private lateinit var logoView: ImageView
    private lateinit var searchContainer: LinearLayout
    private var customView: View? = null
    private lateinit var rootContainer: FrameLayout

    private var isVideoMode = false
    private var hasStartedOnce = false
    private var hasAutoFocused = false

    // כתובות
    private val adUrl = "https://did.li/hotplay-login"
    private val finalUrl = "https://playtv2.github.io/play-tv/"
    private val searchUrl = "https://playtv2.github.io/play-tv/"

    // זהויות (User Agents)
    // זהות מחשב (חובה לניגון אוטומטי מדרייב)
    private val desktopUA = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    // זהות אנדרואיד (חובה להתחברות לחשבון גוגל)
    private val androidUA = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36"

    private var timer: CountDownTimer? = null

    // --- ממשק שליטה (JavaScript Interface) ---
    private val jsInterface = object {
        @JavascriptInterface
        fun triggerCenterClick() {
            runOnUiThread {
                val width = resources.displayMetrics.widthPixels.toFloat()
                val height = resources.displayMetrics.heightPixels.toFloat()
                simulateClickOnWebView(width / 2, height / 2)
            }
        }

        @JavascriptInterface
        fun setVideoMode(active: Boolean) {
            isVideoMode = active
            runOnUiThread { updateSearchAndLogoVisibility(if (active) View.GONE else View.VISIBLE) }
        }

        @JavascriptInterface
        fun exitApp() {
            finishAffinity()
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        rootContainer = findViewById(R.id.rootContainer)
        videoView = findViewById(R.id.videoView)
        webView = findViewById(R.id.webView)
        btnSearch = findViewById(R.id.btnSearch)
        logoView = findViewById(R.id.logoView)
        searchContainer = findViewById(R.id.searchContainer)

        (findViewById<View>(android.R.id.content) as ViewGroup).descendantFocusability = ViewGroup.FOCUS_AFTER_DESCENDANTS

        setupNavButton()
        setupWebView()

        if (savedInstanceState == null && !hasStartedOnce) {
            playFullVideo()
        } else {
            showFinalSite()
        }
    }

    private fun setupNavButton() {
        btnSearch.isFocusable = true
        btnSearch.setOnFocusChangeListener { v, hasFocus ->
            if (hasFocus) {
                searchContainer.setBackgroundColor(Color.BLACK)
                v.scaleX = 1.1f; v.scaleY = 1.1f
                v.setBackgroundColor(Color.WHITE)
                (v as Button).setTextColor(Color.BLACK)
                v.text = "חיפוש"
            } else {
                searchContainer.setBackgroundColor(Color.TRANSPARENT)
                v.scaleX = 1.0f; v.scaleY = 1.0f
                v.setBackgroundColor(Color.parseColor("#80000000"))
                (v as Button).setTextColor(Color.WHITE)
                v.text = ""
            }
        }
        btnSearch.setOnClickListener { webView.loadUrl(searchUrl) }
    }

    private fun setupWebView() {
        val settings = webView.settings
        settings.javaScriptEnabled = true
        settings.domStorageEnabled = true
        settings.databaseEnabled = true
        settings.mediaPlaybackRequiresUserGesture = false 
        settings.mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW
        
        // ברירת מחדל: אנדרואיד (כדי שהלוגין הראשוני יעבוד)
        settings.userAgentString = androidUA

        settings.setSupportMultipleWindows(false)
        settings.javaScriptCanOpenWindowsAutomatically = false

        val cookieManager = CookieManager.getInstance()
        cookieManager.setAcceptCookie(true)
        cookieManager.setAcceptThirdPartyCookies(webView, true)
        cookieManager.flush()

        webView.webChromeClient = object : WebChromeClient() {
            override fun onShowCustomView(view: View?, callback: CustomViewCallback?) {
                customView = view
                rootContainer.addView(view, ViewGroup.LayoutParams(-1, -1))
                webView.visibility = View.GONE
                updateSearchAndLogoVisibility(View.GONE)
            }
            override fun onHideCustomView() {
                rootContainer.removeView(customView)
                customView = null
                webView.visibility = View.VISIBLE
                updateSearchAndLogoVisibility(View.VISIBLE)
            }
        }

        webView.addJavascriptInterface(jsInterface, "AndroidControl")

        webView.webViewClient = object : WebViewClient() {
            override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean { return false }

            // --- מנגנון החלפת זהות חכם ---
            override fun onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) {
                super.onPageStarted(view, url, favicon)
                if (url != null) {
                    // אם זה סרטון דרייב או האתר הראשי שלנו -> תהפוך למחשב (בשביל אוטומציה ועיצוב)
                    if (url.contains("drive.google.com") || url.contains("playtv2.github.io")) {
                        if (view?.settings?.userAgentString != desktopUA) {
                            view?.settings?.userAgentString = desktopUA
                        }
                    } 
                    // אם זה מסך התחברות (Google Accounts) -> תהפוך לאנדרואיד (כדי לא להיחסם)
                    else if (url.contains("accounts.google.com") || url.contains("did.li")) {
                        if (view?.settings?.userAgentString != androidUA) {
                            view?.settings?.userAgentString = androidUA
                        }
                    }
                }
            }

            override fun onPageFinished(view: WebView?, url: String?) {
                super.onPageFinished(view, url)
                injectFocusStyles(view) 

                if (url != null) {
                    // --- 1. זיהוי מסך התחברות וביטול הפרעות ---
                    // אם הגענו למסך התחברות של גוגל
                    if (url.contains("accounts.google.com") || url.contains("ServiceLogin")) {
                        // עוצרים את הטיימר
                        timer?.cancel()
                        timer = null
                        
                        // מעלימים את הסרטון הקטן והלוגו
                        videoView.stopPlayback()
                        videoView.visibility = View.GONE
                        updateSearchAndLogoVisibility(View.GONE)
                        
                        // מחשיבים כאילו "התחלנו" כדי לא להפעיל את הרצף שוב
                        hasStartedOnce = true
                    }

                    // --- 2. מיקוד אוטומטי בכניסה לאתר ---
                    if (!hasAutoFocused && url.contains("github")) {
                        hasAutoFocused = true
                        view?.evaluateJavascript("setTimeout(function(){ var el = document.querySelector('.profile-box, .card'); if(el) el.focus(); }, 1500);", null)
                    }
                }

                // --- 3. אוטומציה אגרסיבית לניגון דרייב ---
                // זה הקוד שעבד לך מצוין קודם
                view?.evaluateJavascript("""
                    (function() {
                        if (window.hpDone) return;
                        var det = setInterval(function() {
                            var f = document.querySelector('iframe[src*="drive.google.com"]');
                            if (f && f.offsetWidth > 0) {
                                window.hpDone = true; clearInterval(det);
                                AndroidControl.setVideoMode(true);
                                
                                // ניקוי הפרעות
                                try {
                                    var style = document.createElement('style');
                                    style.innerHTML = '.ndfHFb-c4YZDc-Wr97p { display: none !important; } .ndfHFb-c4YZDc-i6vT6d { display: none !important; }';
                                    f.contentDocument.head.appendChild(style);
                                } catch(e) {}

                                // מתיחה למסך מלא
                                f.style.position = 'fixed'; f.style.top = '0'; f.style.left = '0';
                                f.style.width = '100vw'; f.style.height = '100vh'; f.style.zIndex = '9999';
                                f.setAttribute('allowfullscreen', 'true');
                                if(document.activeElement) document.activeElement.blur();
                                f.focus();
                                
                                // לחיצה אוטומטית במרכז
                                setTimeout(function() {
                                    AndroidControl.triggerCenterClick();
                                }, 1500);
                            }
                        }, 1000);
                    })();
                """.trimIndent(), null)

                // רק אם זה אתר המעבר ועדיין לא התחלנו - מפעילים טיימר
                if (url != null && (url.contains("did.li")) && !hasStartedOnce) startTimer()
            }
        }
    }

    private fun injectFocusStyles(view: WebView?) {
        val css = """
            html { scroll-behavior: smooth; }
            *:focus { 
                outline: 4px solid white !important; 
                transform: scale(1.1) !important; 
                z-index: 1000 !important; 
                box-shadow: 0 0 20px rgba(0,0,0,0.8);
            }
            body { overflow-x: hidden; }
            ::-webkit-scrollbar { display: none; }
        """.trimIndent()
        view?.evaluateJavascript("var s=document.createElement('style'); s.innerHTML='$css'; document.head.appendChild(s);", null)
    }

    override fun dispatchKeyEvent(event: KeyEvent): Boolean {
        if (videoView.visibility == View.VISIBLE) return super.dispatchKeyEvent(event)

        if (event.action == KeyEvent.ACTION_DOWN) {
            val screenWidth = resources.displayMetrics.widthPixels.toFloat()
            val screenHeight = resources.displayMetrics.heightPixels.toFloat()

            when (event.keyCode) {
                KeyEvent.KEYCODE_DPAD_CENTER, KeyEvent.KEYCODE_ENTER, KeyEvent.KEYCODE_NUMPAD_ENTER, KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE, KeyEvent.KEYCODE_SPACE -> {
                    if (isVideoMode) {
                        simulateClickOnWebView(screenWidth / 2, screenHeight / 2)
                        return true
                    }
                    webView.dispatchKeyEvent(event)
                    return true
                }
                KeyEvent.KEYCODE_BACK, KeyEvent.KEYCODE_ESCAPE, KeyEvent.KEYCODE_DEL -> {
                    val isDriveUrl = webView.url?.contains("drive.google.com") == true
                    if (isVideoMode || isDriveUrl) {
                        isVideoMode = false
                        updateSearchAndLogoVisibility(View.VISIBLE)
                        webView.evaluateJavascript("closeVideo()", null)
                        return true
                    }
                    webView.evaluateJavascript("if(typeof handleBackPress === 'function'){ handleBackPress(); } else { AndroidControl.exitApp(); }", null)
                    return true
                }
                KeyEvent.KEYCODE_DPAD_RIGHT, KeyEvent.KEYCODE_DPAD_LEFT -> {
                    if (isVideoMode) {
                        webView.dispatchKeyEvent(event)
                        return true
                    }
                }
            }
        }
        return super.dispatchKeyEvent(event)
    }

    private fun simulateClickOnWebView(x: Float, y: Float) {
        val dt = SystemClock.uptimeMillis()
        webView.dispatchTouchEvent(MotionEvent.obtain(dt, dt, MotionEvent.ACTION_DOWN, x, y, 0))
        webView.dispatchTouchEvent(MotionEvent.obtain(dt, dt + 50, MotionEvent.ACTION_UP, x, y, 0))
    }

    private fun updateSearchAndLogoVisibility(visibility: Int) { searchContainer.visibility = visibility }

    private fun playFullVideo() {
        updateSearchAndLogoVisibility(View.GONE)
        videoView.visibility = View.VISIBLE
        videoView.setVideoURI(Uri.parse("android.resource://" + packageName + "/" + R.raw.video))
        videoView.setOnCompletionListener { startAdSequence() }
        videoView.start()
    }

    private fun startAdSequence() {
        webView.visibility = View.VISIBLE
        webView.loadUrl(adUrl)
        updateSearchAndLogoVisibility(View.VISIBLE)
        videoView.setVideoURI(Uri.parse("android.resource://" + packageName + "/" + R.raw.video_small))
        videoView.scaleX = 0.22f; videoView.scaleY = 0.22f
        videoView.translationX = -820f; videoView.translationY = 400f
        videoView.setOnCompletionListener { videoView.start() }
        videoView.start()
    }

    private fun showFinalSite() {
        hasStartedOnce = true
        videoView.stopPlayback(); videoView.visibility = View.GONE
        webView.visibility = View.VISIBLE; updateSearchAndLogoVisibility(View.VISIBLE)
        webView.loadUrl(finalUrl)
        webView.requestFocus()
    }

    private fun startTimer() {
        if (timer != null) return
        timer = object : CountDownTimer(15000, 1000) {
            override fun onTick(m: Long) {}
            override fun onFinish() { hasStartedOnce = true; showFinalSite() }
        }.start()
    }
}
